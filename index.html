<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NHM Quoting Tool</title>

  <!-- Choices.js CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
  />

  <!-- INLINE CSS (extract to style.css later) -->
  <style>
    /* Box sizing */
    *, *::before, *::after { box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 30px;
      color: #27488f;
    }
    .logo-container { text-align: center; margin-bottom: 20px; }
    .logo { height: 60px; }
    h1 { text-align: center; margin-bottom: 30px; }
    h2 { font-size: 1.1rem; margin: 25px 0 12px; }

    /* Form */
    #quoteForm {
      max-width: 600px;
      margin: 0 auto 40px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    #quoteForm label { display: block; margin-bottom: 8px; font-weight: 500; }
    #quoteForm input, #quoteForm select {
      width: 100%; padding: 8px; margin-top: 4px;
      border: 1px solid #ccc; border-radius: 4px;
    }
    .nested { margin-left: 15px; margin-top: 12px; }
    #addItem {
      margin-top: 20px; width: 100%; padding: 10px;
      background: #f58020; color: #fff; border: none;
      border-radius: 6px; font-weight: bold; cursor: pointer;
    }

    /* Quote preview */
    .quote-section {
      max-width: 800px; margin: 0 auto;
      background: #fff; padding: 20px;
      border-left: 5px solid #27488f;
      border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    .quote-header {
      display: flex; align-items: center;
      border-bottom: 2px solid #27488f;
      padding-bottom: 10px; margin-bottom: 20px;
    }
    .logo-sm { height: 50px; }
    .company-info { margin-left: 20px; line-height: 1.4; }

    .customer-info {
      display: flex; gap: 40px; margin-bottom: 20px;
    }
    .customer-info p { margin: 4px 0; }

    /* Table */
    .quote-table {
      width: 100%; border-collapse: collapse;
      margin-bottom: 20px;
    }
    .quote-table th, .quote-table td {
      border: 1px solid #ccc; padding: 10px 8px;
      font-size: 0.95rem; vertical-align: middle;
    }
    .quote-table th {
      background: #eef7ec; text-align: left; font-weight: 600;
    }
    .quote-table td.right { text-align: right; }
    /* prevent double border on footers */
    .quote-table tfoot td { border-top: none; }

    /* PDF button */
    #downloadPDF {
      display: block; margin: 0 auto;
      padding: 10px 20px; background: #27488f;
      color: #fff; border: none; border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Logo + Title -->
  <div class="logo-container">
    <img src="nhm-logo.png" alt="NHM Logo" class="logo"/>
  </div>
  <h1>Quote Estimator</h1>

  <!-- Quote Form -->
  <form id="quoteForm">
    <h2>Customer Details</h2>
    <label for="customerName">Customer Name</label>
    <input type="text" id="customerName" placeholder="e.g. Jamie Baker"/>

    <label for="quoteNumber">Quote Number</label>
    <input type="text" id="quoteNumber" placeholder="e.g. Q12345"/>

    <h2>Repair Details</h2>
    <label for="assetSelect">Asset Type</label>
    <select id="assetSelect"></select>

    <div id="makeSection" class="nested" hidden>
      <label for="makeSelect">Make/Model</label>
      <select id="makeSelect"></select>
    </div>

    <div id="repairSection" class="nested" hidden>
      <label for="repairSelect">Repair Type</label>
      <select id="repairSelect"></select>
    </div>

    <div id="optionsSection" class="nested" hidden>
      <label><input type="checkbox" id="supplyOnly"/> Supply Only (no labour)</label>
      <label><input type="checkbox" id="vatExempt"/> VAT Exempt</label>
    </div>

    <button type="button" id="addItem">+ Add Item</button>
  </form>

  <!-- Quote Preview & PDF Export -->
  <section id="quoteSection" class="quote-section" hidden>
    <div id="pdfContent">
      <header class="quote-header">
        <img src="nhm-logo.png" class="logo-sm" alt="NHM Logo"/>
        <div class="company-info">
          <h2>NHM Engineering Ltd</h2>
          <p>
            123 Industrial Park Road<br/>
            Shepperton TW17 9NN<br/>
            Tel: 01932 227 600
          </p>
        </div>
      </header>

      <div class="customer-info">
        <p><strong>Quote #:</strong> <span id="pdfQuoteNumber"></span></p>
        <p><strong>Customer:</strong> <span id="pdfCustomerName"></span></p>
      </div>

      <table class="quote-table">
        <thead>
          <tr>
            <th>Description</th><th>Part #</th><th>Labour</th>
            <th>Materials</th><th>Carriage</th><th>Total</th>
          </tr>
        </thead>
        <tbody id="pdfTableBody"></tbody>
        <tfoot>
          <tr>
            <td colspan="5" class="right">Subtotal</td>
            <td id="pdfSubtotal">£0.00</td>
          </tr>
          <tr>
            <td colspan="5" class="right">VAT</td>
            <td id="pdfVAT">£0.00</td>
          </tr>
          <tr>
            <td colspan="5" class="right"><strong>Total</strong></td>
            <td id="pdfTotal">£0.00</td>
          </tr>
        </tfoot>
      </table>
    </div>
    <button id="downloadPDF">Download PDF</button>
  </section>

  <!-- Dependencies & INLINE JS (extract to script.js later) -->
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
  <script defer>
    const data = {
      "Mobile Hoist": {
        "Oxford Midi 180": {
          "Replacement Battery": { labour_hours: 0.5, material_cost: 85.0, part_number: "OXBATT180" },
          "Handset Replacement":  { labour_hours: 0.75, material_cost: 65.0, part_number: "OXHAND180" }
        }
      }
    };
    let quoteItems = [];
    const refs = {};

    document.addEventListener("DOMContentLoaded", () => {
      // Cache elements
      ["assetSelect","makeSelect","repairSelect",
       "supplyOnly","vatExempt","customerName",
       "quoteNumber","quoteSection","pdfQuoteNumber",
       "pdfCustomerName","pdfTableBody","pdfSubtotal",
       "pdfVAT","pdfTotal","addItem","downloadPDF"]
        .forEach(id => refs[id] = document.getElementById(id));

      // Random placeholder
      const names = ["Terry Clarke","Jayden Davis","Ken McIntyre","Phill Darkin","Matthew Pons","Ashley Henry","Kelly Hart","Andrea Oswald","Jamie Baker","Elliot Bowler-Lee","Steve Cottee","Elena McColl","Paul McMullan","Steven Webb"];
      refs.customerName.placeholder = `e.g. ${names[Math.floor(Math.random()*names.length)]}`;

      // Init Choices.js
      refs.assetCh  = new Choices(refs.assetSelect,  { searchEnabled:true,shouldSort:false });
      refs.makeCh   = new Choices(refs.makeSelect,   { searchEnabled:true,shouldSort:false });
      refs.repairCh = new Choices(refs.repairSelect,{ searchEnabled:true,shouldSort:false });

      // Populate Asset
      populateAssets();
      refs.quoteSection.hidden = true; // hide preview

      // Cascades
      refs.assetSelect.addEventListener("change", () => {
        populateMakes();
        document.getElementById("makeSection").hidden = false;
      });
      refs.makeSelect.addEventListener("change", () => {
        populateRepairs();
        document.getElementById("repairSection").hidden = false;
      });
      refs.repairSelect.addEventListener("change", () => {
        document.getElementById("optionsSection").hidden = false;
      });

      // Live recalc
      refs.supplyOnly.addEventListener("change", render);
      refs.vatExempt .addEventListener("change", render);

      // Add item
      refs.addItem.addEventListener("click", () => {
        if (!refs.assetSelect.value||!refs.makeSelect.value||!refs.repairSelect.value) return;
        quoteItems.push({
          asset: refs.assetSelect.value,
          make:  refs.makeSelect.value,
          repair:refs.repairSelect.value
        });
        refs.quoteSection.hidden = false;
        resetForm();
        render();
      });

      // Download PDF
      refs.downloadPDF.addEventListener("click", () => {
        html2pdf().from(document.getElementById("pdfContent"))
          .set({ margin:10, filename:`Quote_${refs.quoteNumber.value||'No#'}.pdf` })
          .save();
      });
    });

    function populateAssets() {
      const arr = Object.keys(data);
      refs.assetCh.destroy();
      refs.assetSelect.innerHTML = `<option value="" disabled selected>Select Asset</option>${arr.map(a=>`<option value="${a}">${a}</option>`).join("")}`;
      refs.assetCh = new Choices(refs.assetSelect,{searchEnabled:true,shouldSort:false});
    }

    function populateMakes() {
      const arr = data[refs.assetSelect.value] ? Object.keys(data[refs.assetSelect.value]) : [];
      refs.makeCh.destroy();
      refs.makeSelect.innerHTML = `<option value="" disabled selected>Select Make/Model</option>${arr.map(m=>`<option value="${m}">${m}</option>`).join("")}`;
      refs.makeCh = new Choices(refs.makeSelect,{searchEnabled:true,shouldSort:false});
    }

    function populateRepairs() {
      const arr = data[refs.assetSelect.value]?.[refs.makeSelect.value]
        ? Object.keys(data[refs.assetSelect.value][refs.makeSelect.value]) : [];
      refs.repairCh.destroy();
      refs.repairSelect.innerHTML = `<option value="" disabled selected>Select Repair</option>${arr.map(r=>`<option value="${r}">${r}</option>`).join("")}`;
      refs.repairCh = new Choices(refs.repairSelect,{searchEnabled:true,shouldSort:false});
    }

    function resetForm() {
      populateAssets();
      document.getElementById("makeSection").hidden    = true;
      document.getElementById("repairSection").hidden  = true;
      document.getElementById("optionsSection").hidden = true;
      refs.supplyOnly.checked = refs.vatExempt.checked = false;
    }

    function render() {
      refs.pdfTableBody.innerHTML = "";
      let subtotal = 0;
      quoteItems.forEach(it => {
        const info = data[it.asset][it.make][it.repair];
        const labour  = refs.supplyOnly.checked ? 0 : info.labour_hours * 45;
        const carriage= refs.supplyOnly.checked ? 15.95 : 0;
        const line    = labour + info.material_cost + carriage;
        subtotal += line;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${it.asset} → ${it.make} → ${it.repair}</td>
                        <td>${info.part_number}</td>
                        <td>£${labour.toFixed(2)}</td>
                        <td>£${info.material_cost.toFixed(2)}</td>
                        <td>£${carriage.toFixed(2)}</td>
                        <td>£${line.toFixed(2)}</td>`;
        refs.pdfTableBody.appendChild(tr);
      });
      const vatAmt = refs.vatExempt.checked ? 0 : subtotal * 0.2;
      const total  = subtotal + vatAmt;
      refs.pdfSubtotal.textContent     = `£${subtotal.toFixed(2)}`;
      refs.pdfVAT.textContent          = `£${vatAmt.toFixed(2)}`;
      refs.pdfTotal.textContent        = `£${total.toFixed(2)}`;
      refs.pdfQuoteNumber.textContent  = refs.quoteNumber.value || "(No #)";
      refs.pdfCustomerName.textContent = refs.customerName.value || "(No name)";
    }
  </script>
</body>
</html>
